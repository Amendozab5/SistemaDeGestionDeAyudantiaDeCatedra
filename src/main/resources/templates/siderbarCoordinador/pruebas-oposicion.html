<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<body>

<div th:fragment="content">
  <div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Agendar Pruebas de Oposición</h1>
    
    <div id="ajax-success-message" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
      <strong class="font-bold">Éxito!</strong>
      <span class="block sm:inline"></span>
    </div>
    <div id="ajax-error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
      <strong class="font-bold">Error!</strong>
      <span class="block sm:inline"></span>
    </div>

    <div class="bg-white rounded-lg shadow overflow-x-auto">
      <table class="min-w-full w-full">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estudiante</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tribunal Asignado</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asignatura</th>
            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Promedio</th>
            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody id="pruebas-tbody" class="bg-white divide-y divide-gray-200">
          <th:block th:each="entry : ${postulacionesAgrupadas}">
            <tr class="bg-gray-100">
              <td colspan="4" class="px-6 py-3 text-left text-sm font-semibold text-gray-700">
                Asignatura: <span th:text="${entry.key.nombre}"></span>
              </td>
              <td class="px-6 py-3 text-right">
                <button th:data-postulacion-ids="${#strings.listJoin(entry.value.![idPostulacion], ',')}" 
                        class="asignar-tribunal-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                  <i class="fas fa-users-cog mr-2"></i>Asignar Tribunal
                </button>
              </td>
            </tr>
            <tr th:each="postulacion : ${entry.value}" class="postulacion-row">
              <td class="px-6 py-4 whitespace-nowrap">
                  <div class="text-sm font-medium text-gray-900 student-name" th:text="${postulacion.estudiante.usuario.nombres + ' ' + postulacion.estudiante.usuario.apellidos}"></div>
                  <div class="text-sm text-gray-500" th:text="${postulacion.estudiante.carrera.carrera}"></div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <ul class="list-disc list-inside">
                      <li th:each="docente : ${postulacion.tribunalAsignado}" th:text="${docente.usuario.nombres + ' ' + docente.usuario.apellidos}"></li>
                  </ul>
                  <span th:if="${#sets.isEmpty(postulacion.tribunalAsignado)}" class="text-xs text-red-500">No asignado</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 subject-name" th:text="${postulacion.asignatura.nombre}"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${#numbers.formatDecimal(postulacion.estudiante.promedioGeneral, 1, 2)}"></td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button th:data-postulacion-id="${postulacion.idPostulacion}" class="agendar-individual-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                  <i class="fas fa-calendar-alt mr-2"></i>Agendar Individual
                </button>
              </td>
            </tr>
          </th:block>
          <tr th:if="${#maps.isEmpty(postulacionesAgrupadas)}">
            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">No hay postulaciones aprobadas pendientes de agendamiento.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal para Asignar Tribunal -->
  <div id="asignar-tribunal-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Asignar Tribunal al Grupo</h2>
      <form id="asignar-tribunal-form">
        <input type="hidden" id="grupoPostulacionIds" name="postulacionIds" />
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700">Seleccionar Miembros del Tribunal</label>
          <div class="mt-2 max-h-60 overflow-y-auto border border-gray-300 rounded-md p-2">
            <div th:each="docente : ${docentes}" class="flex items-center">
              <input th:id="'tribunal-docente-' + ${docente.id}" name="tribunalIds" th:value="${docente.id}" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
              <label th:for="'tribunal-docente-' + ${docente.id}" class="ml-3 block text-sm text-gray-700" th:text="${docente.usuario.nombres + ' ' + docente.usuario.apellidos}"></label>
            </div>
          </div>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="button" id="cancel-tribunal-modal-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancelar</button>
          <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Guardar Tribunal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal para Agendar Prueba Individual -->
  <div id="agendar-individual-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Agendar Prueba de Oposición</h2>
      <form id="agendar-individual-form" action="/coordinador/agendar-prueba" method="post">
        <input type="hidden" id="postulacionId" name="postulacionId" />
        <div class="mb-4">
          <label for="tema" class="block text-sm font-medium text-gray-700">Tema de Exposición</label>
          <input type="text" name="tema" id="tema" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
        </div>
        <div class="mb-4">
          <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
          <textarea name="descripcion" id="descripcion" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"></textarea>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="fechaHora" class="block text-sm font-medium text-gray-700">Fecha y Hora</label>
            <input type="datetime-local" name="fechaHora" id="fechaHora" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
          </div>
          <div>
            <label for="lugar" class="block text-sm font-medium text-gray-700">Lugar o Enlace</label>
            <input type="text" name="lugar" id="lugar" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" required>
          </div>
        </div>
        <div class="flex justify-end space-x-4">
          <button type="button" id="cancel-individual-modal-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancelar</button>
          <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Confirmar Agendamiento</button>
        </div>
      </form>
    </div>
  </div>

  <script th:inline="javascript">
    (() => {
      const tbody = document.getElementById('pruebas-tbody');
      const csrfToken = /*[[${csrf_token}]]*/ '';
      const csrfHeader = /*[[${csrf_header}]]*/ '';

      // --- Lógica para Modal Asignar Tribunal ---
      const tribunalModal = document.getElementById('asignar-tribunal-modal');
      const tribunalForm = document.getElementById('asignar-tribunal-form');
      const cancelTribunalBtn = document.getElementById('cancel-tribunal-modal-btn');
      const grupoPostulacionIdsInput = document.getElementById('grupoPostulacionIds');

      const showTribunalModal = () => { tribunalModal.classList.remove('hidden'); tribunalModal.classList.add('flex'); };
      const hideTribunalModal = () => { tribunalModal.classList.add('hidden'); tribunalModal.classList.remove('flex'); };

      if(cancelTribunalBtn) cancelTribunalBtn.addEventListener('click', hideTribunalModal);
      if(tribunalModal) tribunalModal.addEventListener('click', (e) => { if(e.target === tribunalModal) hideTribunalModal(); });

      if (tribunalForm) {
        tribunalForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const formData = new FormData(tribunalForm);
          const postulacionIds = formData.get('postulacionIds').split(',').map(id => parseInt(id, 10));
          const tribunalIds = Array.from(formData.getAll('tribunalIds')).map(id => parseInt(id, 10));

          const payload = { postulacionIds, tribunalIds };

          try {
            const response = await fetch('/coordinador/postulaciones/asignar-tribunal', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
              },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              showAjaxMessage('Tribunal asignado con éxito. La página se recargará.', 'success');
              setTimeout(() => window.location.reload(), 2000);
            } else {
              const errorData = await response.json();
              throw new Error(errorData.error || 'Error al asignar el tribunal.');
            }
          } catch (error) {
            showAjaxMessage(error.message, 'error');
          }
          hideTribunalModal();
        });
      }

      // --- Lógica para Modal Agendar Individual ---
      const individualModal = document.getElementById('agendar-individual-modal');
      const cancelIndividualBtn = document.getElementById('cancel-individual-modal-btn');
      const postulacionIdInput = document.getElementById('postulacionId');

      const showIndividualModal = () => { individualModal.classList.remove('hidden'); individualModal.classList.add('flex'); };
      const hideIndividualModal = () => { individualModal.classList.add('hidden'); individualModal.classList.remove('flex'); };

      if(cancelIndividualBtn) cancelIndividualBtn.addEventListener('click', hideIndividualModal);
      if(individualModal) individualModal.addEventListener('click', (e) => { if(e.target === individualModal) hideIndividualModal(); });

      // --- Event Delegation en tbody ---
      if (tbody) {
        tbody.addEventListener('click', (event) => {
          const asignarBtn = event.target.closest('.asignar-tribunal-btn');
          const agendarBtn = event.target.closest('.agendar-individual-btn');

          if (asignarBtn) {
            const ids = asignarBtn.dataset.postulacionIds;
            grupoPostulacionIdsInput.value = ids;
            showTribunalModal();
          }

          if (agendarBtn) {
            postulacionIdInput.value = agendarBtn.dataset.postulacionId;
            showIndividualModal();
          }
        });
      }

      function showAjaxMessage(message, type) {
        const successAlert = document.getElementById('ajax-success-message');
        const errorAlert = document.getElementById('ajax-error-message');
        if (type === 'success') {
          successAlert.querySelector('span').textContent = message;
          successAlert.classList.remove('hidden');
          setTimeout(() => successAlert.classList.add('hidden'), 5000);
        } else {
          errorAlert.querySelector('span').textContent = message;
          errorAlert.classList.remove('hidden');
          setTimeout(() => errorAlert.classList.add('hidden'), 5000);
        }
      }
    })();
  </script>
</div>

</body>
</html>