<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SGAAC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-image: url('/img/uteq.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      transition: background-image 1s ease-in-out;
    }
  </style>
</head>

<body class="bg-gray-100 flex items-center justify-center h-screen">
  <div class="w-full max-w-md">
    <div class="bg-white shadow-md rounded-lg p-8 bg-opacity-75">
      <div class="text-center mb-8">
        <h1 id="auth-title" class="text-3xl font-bold text-gray-800">Iniciar Sesión</h1>
        <p id="auth-subtitle" class="text-gray-500"></p>
      </div>

      <div class="relative">
        <div id="successMessage" class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4"></div>
        <div id="errorMessage" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"></div>

        <!-- Formulario de Inicio de Sesión -->
        <div id="loginForm" class="form-section">
          <form id="loginFormElement">
            <div class="mb-4">
              <label for="loginUsername" class="block text-gray-700 text-sm font-bold mb-2">Usuario</label>
              <input type="text" id="loginUsername" name="username" required placeholder="Ingresa tu usuario"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="mb-6">
              <label for="loginPassword" class="block text-gray-700 text-sm font-bold mb-2">Contraseña</label>
              <div class="relative">
                <input type="password" id="loginPassword" name="password" required placeholder="Ingresa tu contraseña"
                  class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" />
                <span class="absolute inset-y-0 right-0 pr-3 flex items-center cursor-pointer"
                  onclick="togglePassword('loginPassword')">👁</span>
              </div>
            </div>

            <div class="flex items-center justify-between">
              <button type="submit"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                Iniciar Sesión
              </button>
            </div>

            <div class="text-center mt-4">
              <a href="#" class="inline-block align-baseline font-bold text-sm text-green-500 hover:text-green-800"
                onclick="showForgotPassword()">
                ¿Olvidó su contraseña?
              </a>
            </div>

            <div class="text-center mt-4">
              <span class="text-gray-600">¿No tienes cuenta? </span>
              <a href="#" class="font-bold text-sm text-green-500 hover:text-green-800" onclick="showRegisterForm()">
                Regístrate aquí
              </a>
            </div>
          </form>
        </div>

        <!-- Formulario de Registro -->
        <div id="registerForm" class="hidden form-section">
          <form id="registerFormElement" class="grid grid-cols-2 gap-4">
            <div class="col-span-2 sm:col-span-1">
              <label for="registerNombres" class="block text-gray-700 text-sm font-bold mb-2">Nombres</label>
              <input type="text" id="registerNombres" name="nombres" required placeholder="Juan Carlos"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="col-span-2 sm:col-span-1">
              <label for="registerApellidos" class="block text-gray-700 text-sm font-bold mb-2">Apellidos</label>
              <input type="text" id="registerApellidos" name="apellidos" required placeholder="Piguave Moreira"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="col-span-2 sm:col-span-1">
              <label for="registerTelefono" class="block text-gray-700 text-sm font-bold mb-2">Teléfono</label>
              <input type="tel" id="registerTelefono" name="telefono" required placeholder="0999999999"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="col-span-2 sm:col-span-1">
              <label for="registerCedula" class="block text-gray-700 text-sm font-bold mb-2">Cédula</label>
              <input type="text" id="registerCedula" name="cedula" required placeholder="1250000000"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="col-span-2">
              <label for="registerEmail" class="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico</label>
              <input type="email" id="registerEmail" name="email" required placeholder="jpiguave@uteq.edu.ec"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="col-span-2">
              <label class="flex items-center">
                <input type="checkbox" id="termsConditions" name="terms" required class="form-checkbox" />
                <span class="ml-2 text-sm text-gray-600">Acepto los <a href="#"
                    class="text-green-500 hover:text-green-800">términos y condiciones</a></span>
              </label>
            </div>

            <div class="col-span-2">
              <button type="submit"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                Registrarse
              </button>
            </div>

            <div class="col-span-2 text-center mt-4">
              <span class="text-gray-600">¿Ya tienes cuenta? </span>
              <a href="#" class="font-bold text-sm text-green-500 hover:text-green-800" onclick="showLoginForm()">
                Inicia sesión aquí
              </a>
            </div>
          </form>
        </div>

        <!-- Formulario de Recuperación de Contraseña -->
        <div id="forgotPasswordForm" class="hidden form-section">
          <form id="forgotPasswordFormElement">
            <div class="mb-4">
              <label for="forgotUsername" class="block text-gray-700 text-sm font-bold mb-2">Usuario</label>
              <input type="text" id="forgotUsername" name="username" required placeholder="Ingresa tu usuario"
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" />
            </div>

            <div class="flex items-center justify-between">
              <button type="submit"
                class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full">
                Enviar Enlace de Recuperación
              </button>
            </div>

            <div class="text-center mt-4">
              <a href="#" class="inline-block align-baseline font-bold text-sm text-green-500 hover:text-green-800"
                onclick="showLoginForm()">
                Volver al inicio de sesión
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    function showLoginForm() {
      hideAllForms();
      document.getElementById('loginForm').classList.remove('hidden');
      document.getElementById('auth-title').textContent = 'Iniciar Sesión';
      document.getElementById('auth-subtitle').textContent = '';
      clearMessages();
    }

    function showRegisterForm() {
      hideAllForms();
      document.getElementById('registerForm').classList.remove('hidden');
      document.getElementById('auth-title').textContent = 'Crear Cuenta';
      document.getElementById('auth-subtitle').textContent = '';
      clearMessages();
    }

    function showForgotPassword() {
      hideAllForms();
      document.getElementById('forgotPasswordForm').classList.remove('hidden');
      document.getElementById('auth-title').textContent = 'Recuperar Contraseña';
      document.getElementById('auth-subtitle').textContent = 'Te ayudamos a recuperar tu cuenta';
      clearMessages();
    }

    function hideAllForms() {
      document.querySelectorAll('.form-section').forEach(form => form.classList.add('hidden'));
    }

    function clearMessages() {
      document.getElementById('successMessage').classList.add('hidden');
      document.getElementById('errorMessage').classList.add('hidden');
    }

    function showMessage(msg, isError = false) {
      clearMessages();
      const element = isError ? document.getElementById('errorMessage') : document.getElementById('successMessage');
      element.textContent = msg;
      element.classList.remove('hidden');
    }

    function togglePassword(id) {
      const input = document.getElementById(id);
      const toggle = input.nextElementSibling;
      input.type = input.type === 'password' ? 'text' : 'password';
      toggle.textContent = input.type === 'text' ? '🙈' : '👁';
    }

    // 📌 Login (JSON)
    document.getElementById('loginFormElement').addEventListener('submit', function (e) {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!username || !password) {
        showMessage('Por favor, completa todos los campos', true);
        return;
      }

      fetch('/api/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ username, password })
      })
        .then(res => {
          if (!res.ok) {
            return res.json().then(data => {
              throw new Error(Object.values(data).join("\n"));
            });
          }
          return res.json();
        })
        .then(data => {
          showMessage('✅ ¡Inicio de sesión exitoso! Redirigiendo...');
          setTimeout(() => {
            const username = document.getElementById('loginUsername').value.trim();
            switch (data.rol) {
              case "admin":
                window.location.href = "/homeAdmin?username=" + encodeURIComponent(username);
                break;
              case "estudiante":
                window.location.href = "/homeEstudiante?username=" + encodeURIComponent(username);
                break;
              case "docente":
                window.location.href = "/homeDocente?username=" + encodeURIComponent(username);
                break;
              case "decano":
                window.location.href = "/homeDecano?username=" + encodeURIComponent(username);
                break;
              case "coordinador":
                window.location.href = "/homeCoordinador?username=" + encodeURIComponent(username);
                break;
              case "ayudante":
                window.location.href = "/homeEstudiante?username=" + encodeURIComponent(username);
                break;
              default:
                window.location.href = "/login?error=rol_invalido";
            }
          }, 1500);
        })
        .catch(err => showMessage('❌ ' + err.message, true));
    });

    // 📌 Registro (JSON)
    document.getElementById('registerFormElement').addEventListener('submit', function (e) {
      e.preventDefault();

      const nombres = document.getElementById('registerNombres').value.trim();
      const apellidos = document.getElementById('registerApellidos').value.trim();
      const telefono = document.getElementById('registerTelefono').value.trim();
      const cedula = document.getElementById('registerCedula').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const terms = document.getElementById('termsConditions').checked;

      if (!nombres || !apellidos || !telefono || !cedula || !email) {
        showMessage('Por favor, completa todos los campos', true);
        return;
      }

      if (!terms) {
        showMessage('Debes aceptar los términos y condiciones', true);
        return;
      }

      fetch('/api/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ nombres, apellidos, telefono, cedula, email })
      })
        .then(res => {
          if (!res.ok) {
            return res.json().then(data => {
              throw new Error(Object.values(data).join("\n"));
            });
          }
          return res.json();
        })
        .then(data => {
          showMessage('✅ ¡Registro exitoso! Se han enviado las credenciales a tu correo. Ahora puedes iniciar sesión.');
          document.getElementById('registerFormElement').reset();
          setTimeout(() => {
            showLoginForm();
          }, 2000);
        })
        .catch(err => showMessage('❌ ' + err.message, true));
    });

    // 📌 Recuperación
    document.getElementById('forgotPasswordFormElement').addEventListener('submit', function (e) {
      e.preventDefault();
      const username = document.getElementById('forgotUsername').value.trim();
      if (!username) {
        showMessage('Por favor, ingresa tu usuario', true);
        return;
      }

      showMessage('📩 Se ha enviado un enlace de recuperación (si el usuario existe).');
      setTimeout(() => {
        showLoginForm();
      }, 2000);
    });

    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('error')) {
        showMessage('Usuario o contraseña incorrectos.', true);
      }
      if (urlParams.has('logout')) {
        showMessage('Has cerrado sesión exitosamente.');
      }
      showLoginForm();
    });
  </script>
  <script>
    const images = ['/img/uteq.jpg', '/img/uteq2.jpg', '/img/uteq3.jpg', '/img/uteq4.jpg', '/img/uteq5.jpg', '/img/uteq6.jpg'];
    let currentImageIndex = 0;

    function changeBackgroundImage() {
      currentImageIndex = (currentImageIndex + 1) % images.length;
      document.body.style.backgroundImage = `url('${images[currentImageIndex]}')`;
    }

    setInterval(changeBackgroundImage, 5000); // Change image every 5 seconds
  </script>
</body>

</html>