<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Evaluar Pruebas de Oposición</h1>
        
        <div th:if="${pruebas.isEmpty()}" class="bg-white p-6 rounded-lg shadow-md text-center">
            <p class="text-gray-600">No hay pruebas de oposición pendientes de evaluación en este momento.</p>
        </div>

        <div th:unless="${pruebas.isEmpty()}" class="bg-white p-6 rounded-lg shadow-md">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Título de la Prueba</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estudiante</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asignatura</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr th:each="prueba : ${pruebas}" th:id="'prueba-row-' + ${prueba.idOposicion}">
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${prueba.titulo}"></td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${prueba.postulacion.estudiante.usuario.nombres} + ' ' + ${prueba.postulacion.estudiante.usuario.apellidos}"></td>
                            <td class="px-6 py-4 whitespace-nowrap" th:text="${prueba.postulacion.asignatura.nombre}"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span th:switch="${prueba.estado}" class="status-badge px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                                      th:classappend="${prueba.estado == 'AGENDADA' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">
                                    <span th:case="'AGENDADA'">Agendada</span>
                                    <span th:case="'PENDIENTE_CIERRE'">Pendiente de Cierre</span>
                                    <span th:case="*" th:text="${prueba.estado}"></span>
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium action-cell">
                                <div th:switch="${prueba.estado}">
                                    <button th:case="'AGENDADA'" type="button" th:data-id="${prueba.idOposicion}" class="evaluar-btn bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" th:disabled="${!evaluacionCompletaMap[prueba.idOposicion]}">Evaluar</button>
                                    <button th:case="'PENDIENTE_CIERRE'" type="button" th:data-id="${prueba.postulacion.idPostulacion}" class="finalizar-btn bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Revisar y Finalizar</button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Evaluar -->
    <div id="evaluarPruebaModal" class="fixed z-50 inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-4xl transform transition-all">
            <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Evaluar Prueba de Oposición</h2>
                <button class="text-gray-400 hover:text-gray-600 close-evaluar-modal">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="evaluar-modal-content" class="mt-6 space-y-4">
                <!-- Contenido se carga dinámicamente -->
            </div>
             <div class="flex justify-end items-center pt-6 border-t border-gray-200 mt-6">
                <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg close-evaluar-modal">Cancelar</button>
                <button id="guardar-evaluacion-oposicion-btn" type="submit" form="evaluacionForm" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg ml-4">Guardar Evaluación</button>
            </div>
        </div>
    </div>

    <!-- Modal para Finalizar Proceso (nuevo) -->
    <div id="finalizarProcesoModal" class="fixed z-50 inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl p-6 sm:p-8 w-full max-w-2xl transform transition-all">
            <div class="flex justify-between items-center pb-4 border-b border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800">Finalizar Proceso de Selección</h2>
                <button class="text-gray-400 hover:text-gray-600 close-finalizar-modal">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="finalizar-modal-content" class="mt-6 space-y-4">
                <!-- Contenido se carga dinámicamente -->
            </div>
             <div class="flex justify-end items-center pt-6 border-t border-gray-200 mt-6">
                <button type="button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg close-finalizar-modal">Cancelar</button>
                <button id="confirmar-finalizacion-btn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg ml-4">Confirmar y Finalizar</button>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        (function() {
            const evaluarModal = document.getElementById('evaluarPruebaModal');
            const evaluarModalContent = document.getElementById('evaluar-modal-content');

            function openEvaluarModal(id) {
                evaluarModal.classList.remove('hidden');
                evaluarModal.classList.add('flex');
                evaluarModalContent.innerHTML = '<p class="text-center p-8">Cargando...</p>';

                fetch(`/coordinador/oposicion/${id}/evaluar-modal`)
                    .then(response => response.text())
                    .then(html => {
                        evaluarModalContent.innerHTML = html;
                    })
                    .catch(err => {
                        evaluarModalContent.innerHTML = '<p class="text-center p-8 text-red-500">Error al cargar el contenido.</p>';
                        console.error(err);
                    });
            }

            function closeEvaluarModal() {
                evaluarModal.classList.add('hidden');
                evaluarModal.classList.remove('flex');
                evaluarModalContent.innerHTML = '';
            }

            document.querySelectorAll('.evaluar-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = e.currentTarget.dataset.id;
                    openEvaluarModal(id);
                });
            });

            document.querySelectorAll('.close-evaluar-modal').forEach(btn => {
                btn.addEventListener('click', closeEvaluarModal);
            });

            // --- Nueva lógica para el modal de Finalización ---
            const finalizarModal = document.getElementById('finalizarProcesoModal');
            const finalizarModalContent = document.getElementById('finalizar-modal-content');
            const openFinalizarBtns = document.querySelectorAll('.finalizar-btn');
            const closeFinalizarBtns = document.querySelectorAll('.close-finalizar-modal');
            const confirmarBtn = document.getElementById('confirmar-finalizacion-btn');

            function openFinalizarModal(postulacionId) {
                finalizarModal.dataset.postulacionId = postulacionId;
                finalizarModalContent.innerHTML = '<p class="text-center p-8">Cargando resumen...</p>';
                finalizarModal.classList.remove('hidden');
                finalizarModal.classList.add('flex');

                fetch(`/coordinador/finalizacion-detalles/${postulacionId}`)
                    .then(response => {
                        if (!response.ok) throw new Error('No se pudo cargar el resumen.');
                        return response.json();
                    })
                    .then(data => {
                        finalizarModal.dataset.puntajeTotal = data.puntajeTotal; // Guardar puntaje para usarlo después
                        const contentHtml = `
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-lg text-gray-700">Postulante</h3>
                                <p><span class="font-medium">Nombre:</span> ${data.nombreEstudiante}</p>
                                <p><span class="font-medium">Asignatura:</span> ${data.nombreAsignatura}</p>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center mt-4">
                                <div class="p-4 bg-blue-50 rounded-lg">
                                    <p class="text-sm text-blue-800 font-semibold">Puntaje Méritos</p>
                                    <p class="text-2xl font-bold text-blue-900">${data.puntajeMeritos.toFixed(2)} / 20</p>
                                </div>
                                <div class="p-4 bg-green-50 rounded-lg">
                                    <p class="text-sm text-green-800 font-semibold">Puntaje Oposición</p>
                                    <p class="text-2xl font-bold text-green-900">${data.puntajeOposicion.toFixed(2)} / 20</p>
                                </div>
                                <div class="p-4 bg-indigo-50 rounded-lg">
                                    <p class="text-sm text-indigo-800 font-semibold">PUNTAJE FINAL</p>
                                    <p class="text-3xl font-bold text-indigo-900">${data.puntajeTotal.toFixed(2)} / 40</p>
                                </div>
                            </div>
                        `;
                        finalizarModalContent.innerHTML = contentHtml;
                    })
                    .catch(error => {
                        console.error('Error al cargar resumen:', error);
                        finalizarModalContent.innerHTML = '<p class="text-center p-8 text-red-500">Error al cargar el resumen.</p>';
                    });
            }

            function closeFinalizarModal() {
                finalizarModal.classList.add('hidden');
                finalizarModal.classList.remove('flex');
            }

            function confirmarFinalizacion() {
                const postulacionId = finalizarModal.dataset.postulacionId;
                const puntajeTotalFinal = parseFloat(finalizarModal.dataset.puntajeTotal);
                if (!postulacionId || isNaN(puntajeTotalFinal)) return;

                const dataParaGuardar = {
                    puntaje_total_final: puntajeTotalFinal,
                    estado_final: 'CALIFICADO'
                };

                fetch(`/coordinador/finalizar-proceso/${postulacionId}`, { 
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataParaGuardar)
                })
                    .then(response => {
                        if (!response.ok) throw new Error('Error al finalizar el proceso.');
                        return response.json();
                    })
                    .then(data => {
                        console.log(data.message);
                        closeFinalizarModal();
                        // Actualizar la fila en la tabla
                        const btn = document.querySelector(`.finalizar-btn[data-id="${postulacionId}"]`);
                        if (btn) {
                            const row = btn.closest('tr');
                            const statusBadge = row.querySelector('.status-badge');
                            const actionCell = row.querySelector('.action-cell');
                            
                            statusBadge.textContent = 'CALIFICADO';
                            statusBadge.classList.remove('bg-yellow-100', 'text-yellow-800');
                            statusBadge.classList.add('bg-green-100', 'text-green-800');
                            actionCell.innerHTML = '<span class="text-gray-500">Finalizado</span>';
                        }
                    })
                    .catch(error => {
                        console.error('Error al finalizar:', error);
                        alert('No se pudo finalizar el proceso.');
                    });
            }

            openFinalizarBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const postulacionId = e.currentTarget.getAttribute('data-id');
                    openFinalizarModal(postulacionId);
                });
            });

            closeFinalizarBtns.forEach(btn => btn.addEventListener('click', closeFinalizarModal));
            confirmarBtn.addEventListener('click', confirmarFinalizacion);

        })();
        /*]]>*/
    </script>
</div>
</body>
</html>