<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="content">
    <h1 class="text-2xl font-bold mb-6">Gestión de Criterios de Mérito</h1>

    <!-- Formulario para Añadir/Editar Criterios -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-xl font-semibold mb-4" id="form-title">Añadir Nuevo Criterio de Mérito</h2>
        <form id="criterio-form">
            <input type="hidden" id="criterio-id"/>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-4">
                        <label for="criterio-descripcion" class="block text-gray-700 text-sm font-bold mb-2">Descripción del Criterio:</label>
                        <textarea id="criterio-descripcion" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="criterio-puntos" class="block text-gray-700 text-sm font-bold mb-2">Puntos Máximos:</label>
                        <input type="number" id="criterio-puntos" step="0.5" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required/>
                    </div>
                </div>
                <div>
                    <div class="mb-4 flex items-center pt-6">
                        <input type="checkbox" id="criterio-activo" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" checked>
                        <label for="criterio-activo" class="ml-2 block text-sm text-gray-900">Criterio Activo</label>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-end space-x-4 mt-4">
                <button type="button" id="cancel-edit-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline hidden">Cancelar</button>
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Guardar Criterio</button>
            </div>
        </form>
    </div>

    <!-- Lista de Criterios -->
    <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
        <h2 class="text-xl font-semibold mb-4">Criterios de Mérito Actuales</h2>
        <table class="min-w-full bg-white">
            <thead class="bg-gray-50">
                <tr>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Puntos Máx.</th>
                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                    <th class="py-3 px-4 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                </tr>
            </thead>
            <tbody id="criterios-list" class="divide-y divide-gray-200">
                <!-- Los datos se cargarán dinámicamente -->
            </tbody>
        </table>
    </div>

    <script>
      (function() {
        const API_URL = '/api/criterios-merito';

        const form = document.getElementById('criterio-form');
        const formTitle = document.getElementById('form-title');
        const criterioId = document.getElementById('criterio-id');
        const criterioDescripcion = document.getElementById('criterio-descripcion');
        const criterioPuntos = document.getElementById('criterio-puntos');
        const criterioActivo = document.getElementById('criterio-activo');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const criteriosList = document.getElementById('criterios-list');

        async function loadCriterios() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Error al cargar los criterios');
                const criterios = await response.json();
                
                criteriosList.innerHTML = '';
                criterios.forEach(c => {
                    const row = `
                        <tr id="criterio-${c.id}">
                            <td class="py-4 px-4">${c.descripcion}</td>
                            <td class="py-4 px-4">${c.puntosMaximos}</td>
                            <td class="py-4 px-4">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${c.activo ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${c.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </td>
                            <td class="py-4 px-4 text-center flex justify-center space-x-2">
                                <button onclick="window.editCriterio(${c.id}, '${c.descripcion}', ${c.puntosMaximos}, ${c.activo})" class="text-blue-500 hover:text-blue-700" title="Editar"><i class="fas fa-edit"></i></button>
                                <button onclick="window.deleteCriterio(${c.id})" class="text-red-500 hover:text-red-700" title="Eliminar"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                    criteriosList.innerHTML += row;
                });
            } catch (error) {
                console.error(error);
                criteriosList.innerHTML = '<tr><td colspan="4" class="text-center py-4">Error al cargar los criterios.</td></tr>';
            }
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = criterioId.value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/${id}` : API_URL;

            const data = {
                descripcion: criterioDescripcion.value,
                puntosMaximos: parseFloat(criterioPuntos.value),
                activo: criterioActivo.checked
            };

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Error al guardar el criterio');
                
                resetForm();
                loadCriterios();
                showAlertModal('Criterio guardado con éxito.');

            } catch (error) {
                console.error(error);
                showAlertModal(error.message);
            }
        });

        window.editCriterio = function(id, descripcion, puntos, activo) {
            formTitle.textContent = 'Editar Criterio de Mérito';
            criterioId.value = id;
            criterioDescripcion.value = descripcion;
            criterioPuntos.value = puntos;
            criterioActivo.checked = activo;
            cancelBtn.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        window.deleteCriterio = async function(id) {
            showConfirmationModal('¿Estás seguro de que deseas eliminar este criterio?', async () => {
                try {
                    const response = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                    if (!response.ok) throw new Error('Error al eliminar el criterio');
                    
                    loadCriterios();
                    showAlertModal('Criterio eliminado con éxito.');

                } catch (error) {
                    console.error(error);
                    showAlertModal(error.message);
                }
            });
        }

        function resetForm() {
            form.reset();
            formTitle.textContent = 'Añadir Nuevo Criterio de Mérito';
            criterioId.value = '';
            criterioActivo.checked = true;
            cancelBtn.classList.add('hidden');
        }

        cancelBtn.addEventListener('click', resetForm);

        // Carga inicial
        loadCriterios();
      })();
    </script>
</div>
</body>
</html>
